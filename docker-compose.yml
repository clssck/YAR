# LightRAG Work Stack - AWS Bedrock Environment
# Usage: ./setup.sh && docker compose up -d
#
# Services:
#   - lightrag:  Main RAG API + WebUI (port 9621)
#   - litellm:   Unified LLM/Embedding proxy (port 4000)
#   - postgres:  PostgreSQL + pgvector + AGE (port 5432)
#   - rustfs:    S3-compatible storage (ports 9000, 9001)

name: lightrag-stack

networks:
  lightrag-network:
    driver: bridge

services:
  # ══════════════════════════════════════════════════════════════════════════════
  # PostgreSQL with pgvector + Apache AGE
  # ══════════════════════════════════════════════════════════════════════════════
  postgres:
    container_name: lightrag-postgres
    build:
      context: ./docker/postgres-age-vector
      dockerfile: Dockerfile
    environment:
      POSTGRES_DB: lightrag
      POSTGRES_USER: lightrag
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-lightrag_pass}
    ports:
      - '${DOCKER_GATEWAY_IP:-127.0.0.1}:5432:5432'
    volumes:
      - pgdata:/var/lib/postgresql/data
    command: |
      postgres
      -c shared_preload_libraries='vector,age'
      -c max_connections=150
      -c shared_buffers=768MB
      -c work_mem=32MB
      -c checkpoint_completion_target=0.9
      -c effective_cache_size=2GB
      -c maintenance_work_mem=192MB
      -c wal_compression=on
      -c checkpoint_timeout=10min
      -c max_wal_size=1GB
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c max_worker_processes=12
      -c max_parallel_workers_per_gather=4
      -c max_parallel_workers=8
      -c max_parallel_maintenance_workers=4
      -c jit_above_cost=50000
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U lightrag -d lightrag']
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - lightrag-network
    mem_limit: 2g
    restart: unless-stopped

  # ══════════════════════════════════════════════════════════════════════════════
  # RustFS - S3-compatible document storage
  # ══════════════════════════════════════════════════════════════════════════════
  rustfs:
    image: rustfs/rustfs:latest
    container_name: lightrag-rustfs
    ports:
      - '${DOCKER_GATEWAY_IP:-127.0.0.1}:9000:9000'
      - '${DOCKER_GATEWAY_IP:-127.0.0.1}:9001:9001'
    environment:
      RUSTFS_ACCESS_KEY: ${S3_ACCESS_KEY_ID:-rustfsadmin}
      RUSTFS_SECRET_KEY: ${S3_SECRET_ACCESS_KEY:-rustfsadmin}
    command: /data
    volumes:
      - rustfs_data:/data
    healthcheck:
      test: ['CMD-SHELL', "curl -s http://localhost:9000/ | grep -q 'AccessDenied' || curl -sf http://localhost:9000/"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - lightrag-network
    mem_limit: 512m
    restart: unless-stopped

  # ══════════════════════════════════════════════════════════════════════════════
  # LiteLLM Proxy - Unified LLM + Embedding gateway (AWS Bedrock)
  # ══════════════════════════════════════════════════════════════════════════════
  litellm:
    container_name: lightrag-litellm
    build:
      context: ./services/litellm
      dockerfile: Dockerfile
    ports:
      - '${DOCKER_GATEWAY_IP:-127.0.0.1}:4000:4000'
    environment:
      # AWS credentials (inherited from host via IRSA or env vars)
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}
      - AWS_WEB_IDENTITY_TOKEN_FILE
      - AWS_ROLE_ARN
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
      - AWS_SESSION_TOKEN
      # LiteLLM config
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY:-sk-litellm-master-key}
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:4000/health || exit 1']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - lightrag-network
    mem_limit: 1g
    restart: unless-stopped

  # ══════════════════════════════════════════════════════════════════════════════
  # LightRAG API + WebUI
  # ══════════════════════════════════════════════════════════════════════════════
  lightrag:
    container_name: lightrag-api
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - '${DOCKER_GATEWAY_IP:-127.0.0.1}:9621:9621'
    volumes:
      - ./data/rag_storage:/app/data/rag_storage
      - ./data/inputs:/app/data/inputs
    environment:
      # Server
      - HOST=0.0.0.0
      - PORT=9621
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # LLM via LiteLLM proxy
      - LLM_BINDING=openai
      - LLM_MODEL=${LLM_MODEL:-beepboop}
      - LLM_BINDING_HOST=http://litellm:4000/v1
      - LLM_BINDING_API_KEY=${LITELLM_MASTER_KEY:-sk-litellm-master-key}

      # Embedding via LiteLLM proxy (Bedrock Titan v2)
      - EMBEDDING_BINDING=openai
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-bedrock-titan-v2}
      - EMBEDDING_DIM=${EMBEDDING_DIM:-1024}
      - EMBEDDING_BINDING_HOST=http://litellm:4000/v1
      - EMBEDDING_BINDING_API_KEY=${LITELLM_MASTER_KEY:-sk-litellm-master-key}

      # Storage - Full PostgreSQL
      - LIGHTRAG_KV_STORAGE=PGKVStorage
      - LIGHTRAG_VECTOR_STORAGE=PGVectorStorage
      - LIGHTRAG_GRAPH_STORAGE=PGGraphStorage
      - LIGHTRAG_DOC_STATUS_STORAGE=PGDocStatusStorage
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=lightrag
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-lightrag_pass}
      - POSTGRES_DATABASE=lightrag

      # Workspace
      - WORKSPACE=${WORKSPACE:-default}

      # Entity Resolution
      - ENTITY_RESOLUTION_ENABLED=${ENTITY_RESOLUTION_ENABLED:-true}
      - ENTITY_RESOLUTION_FUZZY_THRESHOLD=${ENTITY_RESOLUTION_FUZZY_THRESHOLD:-0.85}
      - ENTITY_RESOLUTION_VECTOR_THRESHOLD=${ENTITY_RESOLUTION_VECTOR_THRESHOLD:-0.5}
      - ENTITY_RESOLUTION_MAX_CANDIDATES=${ENTITY_RESOLUTION_MAX_CANDIDATES:-3}

      # Orphan Connection
      - AUTO_CONNECT_ORPHANS=${AUTO_CONNECT_ORPHANS:-false}
      - ORPHAN_CONNECTION_THRESHOLD=${ORPHAN_CONNECTION_THRESHOLD:-0.3}
      - ORPHAN_CONFIDENCE_THRESHOLD=${ORPHAN_CONFIDENCE_THRESHOLD:-0.7}
      - ORPHAN_CROSS_CONNECT=${ORPHAN_CROSS_CONNECT:-true}

      # Processing
      - MAX_ASYNC=${MAX_ASYNC:-96}
      - MAX_PARALLEL_INSERT=${MAX_PARALLEL_INSERT:-10}
      - EMBEDDING_FUNC_MAX_ASYNC=${EMBEDDING_FUNC_MAX_ASYNC:-4}
      - EMBEDDING_BATCH_NUM=${EMBEDDING_BATCH_NUM:-48}
      - CHUNK_SIZE=${CHUNK_SIZE:-1600}
      - CHUNK_OVERLAP_SIZE=${CHUNK_OVERLAP_SIZE:-100}

      # S3/RustFS
      - S3_ENDPOINT_URL=http://rustfs:9000
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID:-rustfsadmin}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY:-rustfsadmin}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-lightrag}
      - S3_REGION=${S3_REGION:-us-east-1}

      # Gunicorn workers
      - GUNICORN_CMD_ARGS=--workers=8 --worker-class=gthread --threads=4 --worker-connections=1000 --timeout=120 --keep-alive=5 --graceful-timeout=30
    depends_on:
      postgres:
        condition: service_healthy
      rustfs:
        condition: service_healthy
      litellm:
        condition: service_healthy
    entrypoint: []
    command:
      - python
      - -m
      - lightrag.api.run_with_gunicorn
      - --workers
      - '8'
      - --llm-binding
      - openai
      - --embedding-binding
      - openai
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:9621/health || exit 1']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - lightrag-network
    mem_limit: 2g
    restart: unless-stopped

volumes:
  pgdata:
  rustfs_data:
