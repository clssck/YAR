# LightRAG Work Stack - AWS Bedrock Environment
# Usage: ./setup.sh && docker compose up -d
#
# Services:
#   - lightrag:  Main RAG API + WebUI (port 9621)
#   - litellm:   Unified LLM/Embedding proxy (port 4000)
#   - postgres:  PostgreSQL + pgvector + AGE (port 5432)
#   - rustfs:    S3-compatible storage (ports 9000, 9001)

name: lightrag-stack

networks:
  lightrag-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1

services:
  # ══════════════════════════════════════════════════════════════════════════════
  # PostgreSQL with pgvector + Apache AGE
  # ══════════════════════════════════════════════════════════════════════════════
  postgres:
    container_name: lightrag-postgres
    build:
      context: ./docker/postgres-age-vector
      dockerfile: Dockerfile
    environment:
      POSTGRES_DB: lightrag
      POSTGRES_USER: lightrag
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-lightrag_pass}
    ports:
      - '${DOCKER_GATEWAY_IP:-127.0.0.1}:5432:5432'
    volumes:
      - pgdata:/var/lib/postgresql/data
    command: |
      postgres
      -c shared_preload_libraries='vector,age'
      -c max_connections=150
      -c shared_buffers=768MB
      -c work_mem=32MB
      -c checkpoint_completion_target=0.9
      -c effective_cache_size=2GB
      -c maintenance_work_mem=192MB
      -c wal_compression=on
      -c checkpoint_timeout=10min
      -c max_wal_size=1GB
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c max_worker_processes=12
      -c max_parallel_workers_per_gather=4
      -c max_parallel_workers=8
      -c max_parallel_maintenance_workers=4
      -c jit_above_cost=50000
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U lightrag -d lightrag']
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - lightrag-network
    mem_limit: 2g
    restart: unless-stopped

  # ══════════════════════════════════════════════════════════════════════════════
  # RustFS - S3-compatible document storage
  # ══════════════════════════════════════════════════════════════════════════════
  rustfs:
    image: rustfs/rustfs:latest
    container_name: lightrag-rustfs
    ports:
      - '${DOCKER_GATEWAY_IP:-127.0.0.1}:9100:9000'  # S3 API (mapped to 9100 to avoid conflicts)
      - '${DOCKER_GATEWAY_IP:-127.0.0.1}:9101:9001'  # Web console
    environment:
      RUSTFS_ACCESS_KEY: ${S3_ACCESS_KEY_ID:-rustfsadmin}
      RUSTFS_SECRET_KEY: ${S3_SECRET_ACCESS_KEY:-rustfsadmin}
    command: /data
    volumes:
      - rustfs_data:/data
    healthcheck:
      test: ['CMD-SHELL', "curl -s http://localhost:9000/ | grep -q 'AccessDenied' || curl -sf http://localhost:9000/"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - lightrag-network
    mem_limit: 512m
    restart: unless-stopped

  # ══════════════════════════════════════════════════════════════════════════════
  # LiteLLM Proxy - Unified LLM + Embedding gateway (AWS Bedrock)
  # ══════════════════════════════════════════════════════════════════════════════
  litellm:
    container_name: lightrag-litellm
    build:
      context: ./services/litellm
      dockerfile: Dockerfile
    ports:
      - '${DOCKER_GATEWAY_IP:-127.0.0.1}:4000:4000'
    environment:
      # AWS credentials (inherited from host via IRSA or env vars)
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}
      - AWS_WEB_IDENTITY_TOKEN_FILE
      - AWS_ROLE_ARN
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
      - AWS_SESSION_TOKEN
      # LiteLLM config
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY:-sk-litellm-master-key}
    healthcheck:
      test: ['CMD', 'python', '-c', 'import socket; s=socket.socket(); s.settimeout(2); s.connect(("localhost",4000)); s.close()']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - lightrag-network
    mem_limit: 1g
    restart: unless-stopped

volumes:
  pgdata:
  rustfs_data:
